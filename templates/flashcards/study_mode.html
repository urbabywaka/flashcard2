{% extends 'base.html' %}

{% block title %}Study Mode - Flashcard App{% endblock %}

{% block extra_css %}
<style>
    .flashcard-container {
        perspective: 1000px;
        min-height: 400px;
    }
    
    .flashcard {
        width: 100%;
        height: 400px;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s;
        cursor: pointer;
    }
    
    .flashcard.flipped {
        transform: rotateY(180deg);
    }
    
    .flashcard-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .flashcard-front {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }
    
    .flashcard-back {
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        transform: rotateY(180deg);
    }
    
    .flashcard-content {
        text-align: center;
        font-size: 1.5rem;
        font-weight: 500;
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 10px;
        background-color: var(--border-color);
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        border-radius: 10px;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="bi bi-book"></i> Study Mode</h1>
        <p class="text-muted">Click cards to flip â€¢ Mark as known or review</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'flashcards:dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Exit Study
        </a>
    </div>
</div>

<!-- Filter Options -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-5">
                <label class="form-label">Topic</label>
                <select name="topic" class="form-select">
                    <option value="">All Topics</option>
                    {% for topic in topics %}
                    <option value="{{ topic }}" {% if topic == selected_topic %}selected{% endif %}>
                        {{ topic }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Filter</label>
                <select name="only_review" class="form-select">
                    <option value="">All Cards</option>
                    <option value="true" {% if only_review %}selected{% endif %}>Review Only</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel"></i> Apply Filter
                </button>
            </div>
        </form>
    </div>
</div>

{% if flashcards %}
<!-- Progress Bar -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
            <span><strong>Progress:</strong> <span id="current-card">1</span> / {{ total_cards }}</span>
            <span id="known-count">Known: 0</span>
        </div>
        <div class="progress-bar-custom">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Flashcard Display -->
<div class="flashcard-container mb-4">
    <div class="flashcard" id="flashcard" onclick="flipCard()">
        <div class="flashcard-face flashcard-front">
            <div class="flashcard-content">
                <div class="mb-3">
                    <span class="badge bg-light text-dark" id="card-topic"></span>
                </div>
                <div id="card-front"></div>
                <div class="mt-4 text-white-50 small">
                    <i class="bi bi-hand-index"></i> Click to flip
                </div>
            </div>
        </div>
        <div class="flashcard-face flashcard-back">
            <div class="flashcard-content">
                <div id="card-back"></div>
                <div class="mt-4 text-white-50 small">
                    <i class="bi bi-hand-index"></i> Click to flip back
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="card">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <button class="btn btn-success w-100 btn-lg" onclick="markCard('known')">
                    <i class="bi bi-check-circle"></i> I Know This
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-warning w-100 btn-lg" onclick="markCard('review')">
                    <i class="bi bi-arrow-repeat"></i> Review Later
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Study Complete Modal would appear here -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-trophy"></i> Study Session Complete!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-check-circle" style="font-size: 4rem; color: var(--success-color);"></i>
                <h3 class="mt-3">Great job!</h3>
                <p>You've reviewed all <span id="total-reviewed">0</span> flashcards.</p>
                <p><strong id="known-final">0</strong> marked as known</p>
            </div>
            <div class="modal-footer">
                <a href="{% url 'flashcards:dashboard' %}" class="btn btn-primary">
                    <i class="bi bi-house"></i> Back to Dashboard
                </a>
                <a href="{% url 'flashcards:study_mode' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-repeat"></i> Study Again
                </a>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="card text-center py-5">
    <div class="card-body">
        <i class="bi bi-inbox" style="font-size: 4rem; color: var(--text-secondary);"></i>
        <h3 class="mt-3">No Cards to Study</h3>
        <p class="text-muted">Try adjusting your filters or create some flashcards first.</p>
        <a href="{% url 'flashcards:flashcard_create' %}" class="btn btn-primary mt-2">
            <i class="bi bi-plus-circle"></i> Create Flashcard
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if flashcards %}
<script>
    let currentIndex = 0;
    let knownCount = 0;
    let isFlipped = false;
    
    // Flashcard data array
    const cards = [
        {% for card in flashcards %}
        {
            id: {{ card.id }},
            topic: "{{ card.topic|escapejs }}",
            front: "{{ card.front|escapejs }}",
            back: "{{ card.back|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    function loadCard() {
        if (currentIndex >= cards.length) {
            showCompleteModal();
            return;
        }
        
        const card = cards[currentIndex];
        document.getElementById('card-topic').textContent = card.topic;
        document.getElementById('card-front').textContent = card.front;
        document.getElementById('card-back').textContent = card.back;
        document.getElementById('current-card').textContent = currentIndex + 1;
        
        // Update progress
        const progress = ((currentIndex) / cards.length) * 100;
        document.getElementById('progress-fill').style.width = progress + '%';
        
        // Reset flip
        document.getElementById('flashcard').classList.remove('flipped');
        isFlipped = false;
    }
    
    function flipCard() {
        const flashcard = document.getElementById('flashcard');
        flashcard.classList.toggle('flipped');
        isFlipped = !isFlipped;
    }
    
    function markCard(action) {
        const card = cards[currentIndex];
        
        console.log('Marking card:', card.id, 'as', action); // Debug log
        
        // Send AJAX request
        fetch(`/flashcards/${card.id}/mark/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `action=${action}`
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data); // Debug log
            if (data.status === 'success') {
                if (action === 'known') {
                    knownCount++;
                    document.getElementById('known-count').textContent = `Known: ${knownCount}`;
                }
                
                // Move to next card
                currentIndex++;
                loadCard();
            } else {
                console.error('Error:', data.message);
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Network error. Please try again.');
        });
    }
    
    function showCompleteModal() {
        document.getElementById('total-reviewed').textContent = cards.length;
        document.getElementById('known-final').textContent = knownCount;
        const modal = new bootstrap.Modal(document.getElementById('completeModal'));
        modal.show();
        
        // End study session
        fetch('/flashcards/study/end/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            flipCard();
        } else if (e.key === 'ArrowRight' || e.key === 'k') {
            markCard('known');
        } else if (e.key === 'ArrowLeft' || e.key === 'r') {
            markCard('review');
        }
    });
    
    // Load first card
    loadCard();
</script>
{% endif %}
{% endblock %}
